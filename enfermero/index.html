<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfermero - Panel de Control</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .notifications,
        .assigned-beds,
        .requests-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
        }

        .notifications h2,
        .assigned-beds h2,
        .requests-panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }

        .beds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .bed-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bed-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .bed-card.urgent {
            border-color: #dc3545;
            background: #fff5f5;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
            }

            50% {
                box-shadow: 0 0 0 8px rgba(220, 53, 69, 0);
            }
        }

        .bed-card .bed-num {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .bed-card.urgent .bed-num {
            color: #dc3545;
        }

        .alert-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .time-badge {
            background: #ffc107;
            color: #333;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
            display: inline-block;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .logout-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        #qrReader {
            border-radius: 15px;
            overflow: hidden;
            border: 4px solid #667eea;
            margin: 20px 0;
        }

        .camera-status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-loading {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        .status-ready {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #17a2b8;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .info-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .info-section h4 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .info-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .request-item {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-item.attended {
            background: #d4edda;
            border-left-color: #28a745;
            opacity: 0.7;
        }

        .request-info .bed-number {
            font-size: 18px;
            font-weight: bold;
            color: #dc3545;
        }

        .request-item.attended .bed-number {
            color: #28a745;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-pending {
            background: #ffc107;
            color: #333;
        }

        .badge-attended {
            background: #28a745;
            color: white;
        }

        .permission-guide {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .sync-indicator.active {
            display: flex;
        }

        .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>

    <div class="header">
        <h1>üë®‚Äç‚öïÔ∏è Panel de Enfermero</h1>
        <p id="nurseInfo">Bienvenido</p>
    </div>

    <div class="stats">
        <div class="stat-card">
            <h3>Camas Asignadas</h3>
            <div class="number" id="totalBeds">0</div>
        </div>
        <div class="stat-card">
            <h3>Atendidas Hoy</h3>
            <div class="number" id="attendedToday">0</div>
        </div>
        <div class="stat-card">
            <h3>Pendientes</h3>
            <div class="number" id="pendingRequests">0</div>
        </div>
    </div>

    <div class="requests-panel">
        <h2>üîî Solicitudes Recibidas Hoy</h2>
        <div id="requestsList"></div>
    </div>

    <div class="notifications">
        <h2>üîç Consultar Informaci√≥n de Cama</h2>
        <button onclick="openQRScanner()" class="btn btn-primary">üì∑ Escanear QR</button>
        <button onclick="manualEntry()" class="btn btn-secondary">‚å®Ô∏è Ingresar N√∫mero</button>
    </div>

    <div class="assigned-beds">
        <h2>üõèÔ∏è Camas Asignadas</h2>
        <div class="beds-grid" id="bedsGrid"></div>
    </div>

    <div id="qrScannerModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #667eea; margin-bottom: 15px;">üì∑ Escanear C√≥digo QR</h3>
            <div id="cameraStatus" class="camera-status status-loading">Iniciando c√°mara...</div>
            <div id="permissionGuide" class="permission-guide" style="display: none;">
                <h5>üîê Permisos de C√°mara Necesarios</h5>
                <p><strong>C√≥mo activar:</strong></p>
                <ol>
                    <li><strong>Chrome:</strong> Clic en üîí ‚Üí Configuraci√≥n ‚Üí C√°mara ‚Üí Permitir</li>
                    <li><strong>Firefox:</strong> Clic en üîí ‚Üí Permisos ‚Üí C√°mara ‚Üí Permitir</li>
                    <li>Luego recarga la p√°gina</li>
                </ol>
                <button class="btn btn-primary" onclick="reiniciarConPermisos()">üîÑ Reintentar</button>
            </div>
            <div id="qrReader" style="width: 100%; min-height: 300px;"></div>
            <button onclick="closeQRScanner()" class="btn btn-danger">‚èπÔ∏è Cerrar</button>
        </div>
    </div>

    <div id="bedInfoModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #667eea;">üõèÔ∏è Informaci√≥n de Cama <span id="modalBedNumber"></span></h3>
            <div class="info-section">
                <h4>üìã Datos de la Cama</h4>
                <div class="info-item"><strong>N√∫mero:</strong> <span id="infoBedNumber"></span></div>
                <div class="info-item"><strong>Estado:</strong> <span id="infoBedStatus"></span></div>
                <div class="info-item"><strong>ID:</strong> <span id="infoBedId"></span></div>
            </div>
            <div class="info-section" id="patientSection" style="display: none;">
                <h4>üë§ Paciente</h4>
                <div class="info-item"><strong>Nombre:</strong> <span id="infoPatientName"></span></div>
                <div class="info-item"><strong>CURP:</strong> <span id="infoPatientCurp"></span></div>
                <div class="info-item"><strong>Padecimientos:</strong> <span id="infoPatientAilments"></span></div>
                <div class="info-item"><strong>Alta:</strong> <span id="infoPatientAlta"></span></div>
            </div>
            <button onclick="closeBedInfoModal()" class="btn btn-primary">Cerrar</button>
        </div>
    </div>

    <div class="sync-indicator" id="syncIndicator">
        <div class="spinner"></div>
        <span>Actualizando...</span>
    </div>

    <script>
        let html5QrCode, isScanning = false;
        let camasAsignadas = [], solicitudesHoy = [];
        let autoRefreshInterval = null;

        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('authToken');
            const IdUser = localStorage.getItem('userId');
            if (!token || !IdUser) {
                alert("‚ùå No hay sesi√≥n activa");
                window.location.href = "../index.html";
                return;
            }
            await PatchToken();
            await cargarDatos();
            autoRefreshInterval = setInterval(() => cargarDatos(true), 30000);
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        async function cargarDatos(silent = false) {
            if (!silent) showSyncIndicator();
            await Promise.all([getCamas(), getSolicitudes()]);
            if (!silent) hideSyncIndicator();
        }

        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('active');
        }

        function hideSyncIndicator() {
            setTimeout(() => document.getElementById('syncIndicator').classList.remove('active'), 500);
        }

        async function getCamas() {
            const token = localStorage.getItem('authToken');
            const IdUser = localStorage.getItem('userId');
            try {
                const response = await fetch(`https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/enfermero/camas/${IdUser}`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (!response.ok) throw new Error('Error al obtener camas');
                camasAsignadas = data.data || [];
                document.getElementById('totalBeds').innerText = camasAsignadas.length;
                renderBeds(camasAsignadas);
            } catch (error) {
                console.error(error);
            }
        }

        async function getSolicitudes() {
            const token = localStorage.getItem('authToken');
            const IdUser = localStorage.getItem('userId');
            try {
                const response = await fetch(`https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/alertas/enfermero/${IdUser}`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    solicitudesHoy = [];
                    renderSolicitudes([]);
                    return;
                }
                const data = await response.json();
                solicitudesHoy = data.data || [];
                renderSolicitudes(solicitudesHoy);
                const pendientes = solicitudesHoy.filter(s => !s.atendida).length;
                const atendidas = solicitudesHoy.filter(s => s.atendida).length;
                document.getElementById('pendingRequests').innerText = pendientes;
                document.getElementById('attendedToday').innerText = atendidas;
            } catch (error) {
                console.error(error);
                solicitudesHoy = [];
                renderSolicitudes([]);
            }
        }

        function renderSolicitudes(solicitudes) {
            const requestsList = document.getElementById('requestsList');
            if (solicitudes.length === 0) {
                requestsList.innerHTML = '<div class="empty-state"><p>‚úÖ No hay solicitudes</p></div>';
                return;
            }
            solicitudes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            requestsList.innerHTML = solicitudes.map(req => {
                const fecha = new Date(req.fecha);
                const diffMin = Math.floor((new Date() - fecha) / 60000);
                let tiempo = diffMin < 1 ? 'Ahora' : diffMin < 60 ? `${diffMin}min` : `${Math.floor(diffMin / 60)}h`;
                return `
                    <div class="request-item ${req.atendida ? 'attended' : ''}">
                        <div class="request-info">
                            <div class="bed-number">üõèÔ∏è Cama ${req.numeroCama || req.camaId}</div>
                            <div>${fecha.toLocaleTimeString('es-MX')} - Hace ${tiempo}</div>
                        </div>
                        <div>
                            <span class="badge ${req.atendida ? 'badge-attended' : 'badge-pending'}">
                                ${req.atendida ? 'Atendida' : 'Pendiente'}
                            </span>
                            ${!req.atendida ? `<button class="btn btn-success" onclick="marcarAtendida(${req.id})">‚úì</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function marcarAtendida(alertaId) {
            const token = localStorage.getItem('authToken');
            try {
                const response = await fetch(`https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/alertas/${alertaId}/atender`, {
                    method: 'PATCH',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) await getSolicitudes();
            } catch (error) {
                console.error(error);
            }
        }

        function renderBeds(camas) {
            const bedsGrid = document.getElementById('bedsGrid');
            if (camas.length === 0) {
                bedsGrid.innerHTML = '<div class="empty-state"><p>No tienes camas asignadas</p></div>';
                return;
            }
            bedsGrid.innerHTML = camas.map(c => {
                const pendientes = solicitudesHoy.filter(s => s.camaId === c.id && !s.atendida);
                const urgente = pendientes.length > 0;
                let badge = '', tiempo = '';
                if (urgente) {
                    const ultima = pendientes[0];
                    const diffMin = Math.floor((new Date() - new Date(ultima.fecha)) / 60000);
                    tiempo = `<span class="time-badge">Hace ${diffMin}min</span>`;
                    badge = `<span class="alert-badge">üî¥ ${pendientes.length}</span>`;
                }
                return `
                    <div class="bed-card ${urgente ? 'urgent' : ''}">
                        ${badge}
                        <div class="bed-num">Cama ${c.cama}</div>
                        <div class="patient-info">
                            <p><strong>ID:</strong> ${c.id}</p>
                            <p><strong>Estado:</strong> ${c.ocupada ? "Ocupada" : "Libre"}</p>
                            ${tiempo}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openQRScanner() {
            document.getElementById('qrScannerModal').classList.add('active');
            initQRScanner();
        }

        async function closeQRScanner() {
            if (html5QrCode) {
                try { await html5QrCode.stop(); } catch (err) { }
            }
            document.getElementById('qrScannerModal').classList.remove('active');
            isScanning = false;
        }

        async function initQRScanner() {
            try {
                updateCameraStatus("Solicitando permisos de c√°mara...", "loading");

                html5QrCode = new Html5Qrcode("qrReader");

                const config = {
                    fps: 30,
                    qrbox: { width: 300, height: 300 },
                    aspectRatio: 1.0,
                    disableFlip: false,
                    experimentalFeatures: { useBarCodeDetectorIfSupported: true },
                    showTorchButtonIfSupported: true,
                    formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE]
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText) => {
                        onQRCodeScanned(decodedText);
                    },
                    (errorMessage) => {
                        // errores menores no cr√≠ticos
                    }
                );

                isScanning = true;
                updateCameraStatus("‚úÖ C√°mara lista. Enfoca el c√≥digo QR", "ready");

            } catch (err) {
                console.error("Error al iniciar c√°mara:", err);

                if (err.name === "NotAllowedError") {
                    showPermissionDenied();
                } else if (err.name === "NotFoundError") {
                    updateCameraStatus("‚ùå No se encontr√≥ ninguna c√°mara.", "error");
                } else if (err.name === "NotReadableError") {
                    updateCameraStatus("‚ùå La c√°mara est√° siendo usada por otra aplicaci√≥n.", "error");
                } else {
                    updateCameraStatus("‚ùå No se pudo acceder a la c√°mara.", "error");
                }
            }
        }

        async function reiniciarConPermisos() {
            document.getElementById("permissionGuide").style.display = "none";
            await initQRScanner();
        }

        async function onQRCodeScanned(qrText) {
            if (!isScanning) return;
            isScanning = false;
            qrText = qrText.trim().toUpperCase();
            if (!qrText.startsWith("CAMA:")) {
                updateCameraStatus("‚ùå QR inv√°lido", "error");
                setTimeout(() => { isScanning = true; }, 2000);
                return;
            }
            const camaId = qrText.split(":")[1];
            if (!camaId || isNaN(camaId)) {
                updateCameraStatus("‚ùå ID inv√°lido", "error");
                setTimeout(() => { isScanning = true; }, 2000);
                return;
            }
            const tengoPermiso = camasAsignadas.find(c => c.id == camaId);
            if (!tengoPermiso) {
                updateCameraStatus("‚ùå Esta cama NO est√° asignada a ti", "error");
                setTimeout(() => { isScanning = true; }, 3000);
                return;
            }
            await fetchBedInfo(camaId);
        }

        async function fetchBedInfo(camaId) {
            const token = localStorage.getItem('authToken');
            const tengoPermiso = camasAsignadas.find(c => c.id == camaId);
            if (!tengoPermiso) {
                alert("‚ùå No tienes permiso para ver esta cama");
                return;
            }
            try {
                const response = await fetch(`https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/pc/find-pc/${camaId}`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (!response.ok) {
                    updateCameraStatus("‚ùå No se encontr√≥ la cama", "error");
                    setTimeout(() => { isScanning = true; }, 2000);
                    return;
                }
                const data = await response.json();
                await closeQRScanner();
                showBedInfo(data);
            } catch (error) {
                console.error(error);
                updateCameraStatus("‚ùå Error de conexi√≥n", "error");
                setTimeout(() => { isScanning = true; }, 2000);
            }
        }

        function showBedInfo(response) {
            const { cama, paciente } = response.data;
            document.getElementById('modalBedNumber').textContent = cama.cama;
            document.getElementById('infoBedNumber').textContent = cama.cama;
            document.getElementById('infoBedId').textContent = cama.id;
            document.getElementById('infoBedStatus').textContent = cama.ocupada ? "Ocupada" : "Disponible";
            const patientSection = document.getElementById('patientSection');
            if (paciente && response.data.activo) {
                patientSection.style.display = 'block';
                document.getElementById('infoPatientName').textContent = `${paciente.nombre} ${paciente.paterno} ${paciente.materno}`;
                document.getElementById('infoPatientCurp').textContent = paciente.curp || 'N/A';
                document.getElementById('infoPatientAilments').textContent = paciente.padecimientos || 'Sin registro';
                document.getElementById('infoPatientAlta').textContent = paciente.alta ? 'S√≠' : 'No';
            } else {
                patientSection.style.display = 'none';
            }
            document.getElementById('bedInfoModal').classList.add('active');
        }

        function closeBedInfoModal() {
            document.getElementById('bedInfoModal').classList.remove('active');
        }

        function showPermissionDenied() {
            updateCameraStatus("‚ùå Permiso de c√°mara denegado. Por favor permite el acceso.", "error");

            // Agregar bot√≥n de reintento
            const qrReader = document.getElementById("qrReader");
            const retryBtnId = "retryCameraBtn";

            if (!document.getElementById(retryBtnId)) {
                const retryBtn = document.createElement("button");
                retryBtn.textContent = "üîÑ Reintentar c√°mara";
                retryBtn.id = retryBtnId;
                retryBtn.classList.add("btn", "btn-primary");
                retryBtn.style.display = "block";
                retryBtn.style.margin = "10px auto";
                retryBtn.onclick = () => {
                    retryBtn.remove();
                    initQRScanner();
                };
                qrReader.appendChild(retryBtn);
            }
        }

        function manualEntry() {
            const camaId = prompt("Ingresa el ID de la cama:");
            if (camaId && !isNaN(camaId)) {
                fetchBedInfo(camaId);
            } else if (camaId) {
                alert("‚ùå N√∫mero inv√°lido");
            }
        }

        function updateCameraStatus(message, type) {
            const el = document.getElementById("cameraStatus");
            el.innerHTML = message;
            el.className = `camera-status status-${type}`;
        }

       

        function logout() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            localStorage.clear();
            window.location.href = '../index.html';
        }
    </script>
</body>

</html>