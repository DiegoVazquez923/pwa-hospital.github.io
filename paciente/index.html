<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Cama - Paciente</title>

   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>

    <style>
        body {
            background: #f4f6f9;
            min-height: 100vh;
        }

        .scan-container {
            max-width: 500px;
            margin: 40px auto;
            background: #fff;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        #qrReader {
            border-radius: 15px;
            overflow: hidden;
            border: 4px solid #4CAF50;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.3);
        }

        #qrReader video {
            border-radius: 12px;
            transform: scaleX(-1);
            -webkit-transform: scaleX(-1);
        }

        .camera-status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-loading { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .status-ready { background: #d1ecf1; color: #0c5460; border: 2px solid #17a2b8; }
        .status-success { background: #d4edda; color: #155724; border: 2px solid #28a745; }
        .status-error { background: #f8d7da; color: #721c24; border: 2px solid #dc3545; }

        .scanning-indicator {
            position: relative;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .scanning-indicator::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            height: 100%; width: 40%;
            background: linear-gradient(90deg, transparent, #4CAF50, transparent);
            animation: scan 2s infinite;
        }

        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(350%); }
        }

        .btn-control {
            margin: 5px;
            min-width: 120px;
        }

        .permission-guide {
            background: #e7f3ff;
            border: 2px solid #2196F3;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .permission-guide h5 {
            color: #0d47a1;
            margin-bottom: 15px;
        }

        .permission-steps {
            text-align: left;
            margin: 10px 0;
        }

        .permission-steps li {
            margin: 8px 0;
            padding-left: 5px;
        }
    </style>
</head>

<body>

   
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4">
        <a class="navbar-brand fw-bold" href="#">üè• Hospital</a>
        <div class="ms-auto">
            <a href="./ayuda.html" class="btn btn-primary">Ir a Ayuda</a>
        </div>
        <div class="ms-auto">
            <a onclick="logout()" class="btn btn-primary">Cerrar Sesi√≥n</a>
        </div>
    </nav>

   
    <div class="scan-container text-center">

        <h3 class="mb-3">üì∑ Escanea el c√≥digo QR de tu cama</h3>

        <p class="text-muted mb-3">
            <strong>üí° Consejos para escanear:</strong><br>
            ‚Ä¢ Mant√©n el QR dentro del cuadro verde<br>
            ‚Ä¢ Aseg√∫rate de tener buena iluminaci√≥n<br>
            ‚Ä¢ Mant√©n el QR a 15-20 cm de la c√°mara<br>
            ‚Ä¢ Si no funciona, intenta m√°s cerca o m√°s lejos
        </p>

       
        <div id="cameraStatus" class="camera-status status-loading">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Iniciando c√°mara...
        </div>

        
        <div id="permissionGuide" class="permission-guide" style="display: none;">
            <h5>üîê Permisos de C√°mara Necesarios</h5>
            <p>Para escanear el c√≥digo QR necesitamos acceso a tu c√°mara.</p>
            
            <div class="permission-steps">
                <strong>üì± C√≥mo activar los permisos:</strong>
                <ol>
                    <li><strong>Chrome/Edge:</strong> Haz clic en el icono üîí junto a la URL ‚Üí Configuraci√≥n del sitio ‚Üí C√°mara ‚Üí Permitir</li>
                    <li><strong>Firefox:</strong> Haz clic en el icono üîí ‚Üí Permisos ‚Üí C√°mara ‚Üí Permitir</li>
                    <li><strong>Safari (iOS):</strong> Ajustes ‚Üí Safari ‚Üí C√°mara ‚Üí Preguntar o Permitir</li>
                    <li><strong>Android:</strong> Configuraci√≥n ‚Üí Apps ‚Üí [Navegador] ‚Üí Permisos ‚Üí C√°mara</li>
                </ol>
            </div>

            <button class="btn btn-primary mt-3" onclick="reiniciarConPermisos()">
                üîÑ Reintentar con Permisos
            </button>
        </div>

       
        <div id="scanningIndicator" class="scanning-indicator" style="display: none;"></div>

      
        <div id="qrReader" style="width: 100%; min-height: 300px;"></div>

        
        <div id="controls" class="mt-3" style="display: none;">
            <button id="btnStop" class="btn btn-danger btn-control" onclick="stopScanner()">
                ‚èπÔ∏è Detener C√°mara
            </button>
            <button id="btnRestart" class="btn btn-success btn-control" onclick="restartScanner()">
                üîÑ Reiniciar
            </button>
        </div>

        
        <p id="status" class="mt-3 fw-bold"></p>

       
        <div id="debugInfo" class="debug-info" style="display: none;">
            <strong>üîç Debug:</strong>
            <div id="debugText">Esperando escaneo...</div>
        </div>
    </div>

    <script>
        let html5QrCode;
        let isScanning = false;
        let scanCount = 0;
        let permisosOtorgados = false;

        document.addEventListener("DOMContentLoaded", async () => {
            
            const token = localStorage.getItem("authToken");
            const IdUser = localStorage.getItem("userId");

            if (!token || !IdUser) {
                alert("‚ùå No hay sesi√≥n activa. Redirigiendo al login...");
                window.location.href = "../index.html";
                return;
            }

           
            await verificarPermisos();
        });

        
        async function verificarPermisos() {
            try {
                updateStatus("Verificando permisos de c√°mara...", "loading");

             
                if (navigator.permissions && navigator.permissions.query) {
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    
                    if (permissionStatus.state === 'granted') {
                        permisosOtorgados = true;
                        updateDebug("Permisos de c√°mara otorgados");
                        await initQRScanner();
                    } else if (permissionStatus.state === 'denied') {
                        permisosOtorgados = false;
                        mostrarGuiaPermisos();
                    } else {
                       
                        await initQRScanner();
                    }

                    
                    permissionStatus.onchange = function() {
                        if (this.state === 'granted') {
                            permisosOtorgados = true;
                            ocultarGuiaPermisos();
                            initQRScanner();
                        } else if (this.state === 'denied') {
                            permisosOtorgados = false;
                            mostrarGuiaPermisos();
                        }
                    };
                } else {
                   
                    await initQRScanner();
                }

            } catch (error) {
                console.error("Error verificando permisos:", error);
               
                await initQRScanner();
            }
        }

        
        function mostrarGuiaPermisos() {
            document.getElementById("permissionGuide").style.display = "block";
            document.getElementById("qrReader").style.display = "none";
            document.getElementById("controls").style.display = "none";
            document.getElementById("scanningIndicator").style.display = "none";
            
            updateStatus("‚ùå Permiso de c√°mara denegado", "error");
            updateDebug("Permisos denegados. Mostrando gu√≠a al usuario.");
        }

        
        function ocultarGuiaPermisos() {
            document.getElementById("permissionGuide").style.display = "none";
            document.getElementById("qrReader").style.display = "block";
        }

        
        async function reiniciarConPermisos() {
            updateStatus("Solicitando permisos nuevamente...", "loading");
            ocultarGuiaPermisos();
            await verificarPermisos();
        }

        
        async function initQRScanner() {
            try {
                updateStatus("Solicitando permisos de c√°mara...", "loading");

                html5QrCode = new Html5Qrcode("qrReader");

                const config = {
                    fps: 20,
                    qrbox: 250,
                    aspectRatio: 1.0,
                    disableFlip: false,
                    experimentalFeatures: {
                        useBarCodeDetectorIfSupported: true
                    },
                    rememberLastUsedCamera: true,
                    showTorchButtonIfSupported: true
                };

                await html5QrCode.start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        onQRCodeScanned(decodedText, decodedResult);
                    },
                    (errorMessage) => {
                        scanCount++;
                        updateDebug(`Intentos: ${scanCount} | ${errorMessage.substring(0, 50)}...`);
                    }
                );

                
                permisosOtorgados = true;
                isScanning = true;
                document.getElementById("controls").style.display = "block";
                document.getElementById("scanningIndicator").style.display = "block";
                updateStatus("‚úÖ C√°mara lista. Enfoca el c√≥digo QR", "ready");
                updateDebug("C√°mara activa. Acerca el QR al cuadro verde.");

            } catch (err) {
                console.error("Error al iniciar c√°mara:", err);
                permisosOtorgados = false;

                let errorMsg = "‚ùå No se pudo acceder a la c√°mara.";

                if (err.name === "NotAllowedError") {
                    errorMsg = "‚ùå Permiso de c√°mara denegado.";
                    mostrarGuiaPermisos();
                } else if (err.name === "NotFoundError") {
                    errorMsg = "‚ùå No se encontr√≥ ninguna c√°mara en este dispositivo.";
                } else if (err.name === "NotReadableError") {
                    errorMsg = "‚ùå La c√°mara est√° siendo usada por otra aplicaci√≥n.";
                }

                updateStatus(errorMsg, "error");
                updateDebug(`Error: ${err.name} - ${err.message}`);
            }
        }

       
        async function onQRCodeScanned(qrText, decodedResult) {
            if (!isScanning) return;
            isScanning = false;

            qrText = qrText.trim().toUpperCase();

            console.log("‚úÖ QR detectado:", qrText);
            updateDebug(`QR Detectado: ${qrText}`);

            
            if (!qrText.startsWith("CAMA:")) {
                updateStatus("‚ùå QR inv√°lido. Debe tener formato CAMA:ID", "error");
                updateDebug(`Formato incorrecto. Esperado: CAMA:X, Recibido: ${qrText}`);
                setTimeout(() => { isScanning = true; }, 2000);
                return;
            }

            const camaId = qrText.split(":")[1];

            if (!camaId || isNaN(camaId)) {
                updateStatus("‚ùå El c√≥digo QR no contiene un ID v√°lido.", "error");
                updateDebug(`ID inv√°lido: ${camaId}`);
                setTimeout(() => { isScanning = true; }, 2000);
                return;
            }

            
            updateStatus("‚è≥ Verificando disponibilidad de cama...", "loading");
            
            const camaDisponible = await verificarCamaDisponible(camaId);
            
            if (!camaDisponible) {
                updateStatus("‚ùå Esta cama no est√° disponible o est√° deshabilitada.", "error");
                updateDebug(`Cama ID ${camaId} no disponible`);
                setTimeout(() => { isScanning = true; }, 3000);
                return;
            }

            updateStatus("‚è≥ Vinculando cama al paciente...", "loading");

            const token = localStorage.getItem("authToken");
            const IdUser = localStorage.getItem("userId");

            updateDebug(`Vinculando cama ID: ${camaId} con paciente ID: ${IdUser}`);

            try {
                if (!token || !IdUser) {
                    updateStatus("‚ùå No hay sesi√≥n activa. Por favor inicia sesi√≥n.", "error");
                    updateDebug("Token o ID de usuario no encontrado en localStorage");
                    setTimeout(() => {
                        window.location.href = "../index.html";
                    }, 2000);
                    return;
                }

                const res = await fetch('https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/pc/new-pc', {
                    method: 'POST',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        pacienteId: parseInt(IdUser),
                        camaId: parseInt(camaId),
                        activo: true
                    })
                });

                updateDebug(`Respuesta del servidor: ${res.status} ${res.statusText}`);

                if (!res.ok) {
                    const errorData = await res.json().catch(() => null);
                    updateStatus("‚ùå Error al vincular la cama. Intenta nuevamente.", "error");
                    updateDebug(`Error HTTP ${res.status}: ${errorData?.message || 'Error desconocido'}`);
                    setTimeout(() => { isScanning = true; }, 2000);
                    return;
                }

                const response = await res.json();
                console.log("Respuesta del servidor:", response);
                updateDebug(`Vinculaci√≥n exitosa: ${JSON.stringify(response)}`);

                const data = {
                    bedId: camaId,
                    bedNumber: camaId,
                    patientId: IdUser,
                    linkedAt: new Date().toISOString()
                };

                localStorage.setItem("patient_linked_bed", JSON.stringify(data));

                updateStatus("‚úÖ Cama vinculada correctamente. Redirigiendo...", "success");
                updateDebug(`Datos guardados en localStorage: ${JSON.stringify(data)}`);

                await html5QrCode.stop();

                setTimeout(() => {
                    window.location.href = "./ayuda.html";
                }, 1500);

            } catch (err) {
                console.error("Error en la petici√≥n:", err);
                updateStatus("‚ùå Error conectando con el servidor.", "error");
                updateDebug(`Error de red: ${err.message}`);
                setTimeout(() => { isScanning = true; }, 2000);
            }
        }

        async function verificarCamaDisponible(camaId) {
            try {
                const response = await fetch(`https://liquescent-jazlynn-speculatively.ngrok-free.dev/api/camas/${camaId}`, {
                    method: 'GET',
                    headers: {
                        'ngrok-skip-browser-warning': 'true',
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    return false;
                }

                const cama = await response.json();
            
                
                return cama.activo === true || cama.disponible === true;

            } catch (error) {
                console.error("Error verificando cama:", error);
                return true; 
            }
        }

        async function stopScanner() {
            if (html5QrCode) {
                try {
                    await html5QrCode.stop();
                    isScanning = false;
                    updateStatus("‚èπÔ∏è C√°mara detenida", "error");
                    document.getElementById("scanningIndicator").style.display = "none";
                } catch (err) {
                    console.error("Error al detener:", err);
                }
            }
        }

        async function restartScanner() {
            await stopScanner();
            scanCount = 0;
            ocultarGuiaPermisos();
            setTimeout(() => {
                verificarPermisos();
            }, 500);
        }

        function updateStatus(message, type) {
            const statusEl = document.getElementById("status");
            const cameraStatusEl = document.getElementById("cameraStatus");

            statusEl.textContent = message;
            cameraStatusEl.innerHTML = message;

            cameraStatusEl.classList.remove("status-loading", "status-ready", "status-success", "status-error");

            if (type === "loading") {
                cameraStatusEl.classList.add("status-loading");
                cameraStatusEl.innerHTML = `<div class="spinner-border spinner-border-sm me-2"></div>${message}`;
            } else if (type === "ready") {
                cameraStatusEl.classList.add("status-ready");
            } else if (type === "success") {
                cameraStatusEl.classList.add("status-success");
            } else if (type === "error") {
                cameraStatusEl.classList.add("status-error");
            }
        }

        function updateDebug(message) {
            const debugEl = document.getElementById("debugText");
            const timestamp = new Date().toLocaleTimeString();
            debugEl.innerHTML = `[${timestamp}] ${message}`;
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userId');
            localStorage.removeItem('userRole');
            localStorage.removeItem('fcmToken');
            localStorage.removeItem('patient_linked_bed');
            localStorage.removeItem('username');
            window.location.href = '../index.html';
        }
    </script>

</body>

</html>